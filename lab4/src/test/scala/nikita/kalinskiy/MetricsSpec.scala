package nikita.kalinskiy

import org.scalatest.OptionValues
import org.scalatest.flatspec.AnyFlatSpec
import org.scalatest.matchers.should.Matchers

class MetricsSpec extends AnyFlatSpec with Matchers with OptionValues {
  import MetricsSpec._

  "vwapMid" should "be correct" in {
    val input = orderbook.split(',').toList
    val entry = Entry.fromLine(input).value
    Metrics.vwapMid(entry) shouldEqual vwapMidpoint
  }

  "instant metrics" should "be calculated correctly" in {
    val input   = orderbook.split(',').toList
    val entry   = Entry.fromLine(input).value
    val metrics = InstantMetrics.metrics(entry.bids, entry.asks)
    metrics.head shouldEqual midPoint
    metrics(1) shouldEqual vwapAsks
    metrics(2) shouldEqual vwapBids
    metrics.last shouldEqual vwapMidpoint
  }

  "sma with window size = 10" should "be correct" in {
    val entries = for { orderbook <- window } yield Entry.fromLine(orderbook.split(',').toList).value
    SmaMetrics.sma(entries) shouldEqual correctSma
  }

  "ema with window size = 10" should "be correct" in {
    val entries = for { orderbook <- window } yield Entry.fromLine(orderbook.split(',').toList).value
    val emas = entries.scanLeft((0.0, 0)) { (res, entry) =>
      val n     = res._2 + 1
      val alpha = 2.0 / (n + 1)
      val vwap  = Metrics.vwapMid(entry)
      val ema   = alpha * vwap + (1 - alpha) * res._1
      (ema, n)
    }
    emas.last._1 shouldEqual correctEma
  }
}

object MetricsSpec {
  private val orderbook =
    "2020-02-09 19:34:20,XBTUSD,10112.0,52519,10111.5,301345,10111.0,92817,10110.5,192572,10110.0,128765,10109.5,12415,10109.0,52192,10108.5,374673,10108.0,54287,10107.5,88770,10107.0,260573,10106.5,431409,10106.0,246549,10105.5,99312,10105.0,525907,10104.5,196953,10104.0,511442,10103.5,145059,10103.0,7977,10102.5,131573,10102.0,33399,10101.5,59453,10101.0,54206,10100.5,89967,10100.0,1901198,10099.5,725571,10099.0,52367,10098.5,1863,10098.0,126406,10097.5,1436,10097.0,140522,10096.5,66374,10096.0,92830,10095.5,31524,10095.0,106265,10094.5,528326,10094.0,38185,10093.5,178506,10093.0,164037,10092.5,347790,10092.0,235553,10091.5,146301,10091.0,56262,10090.5,111631,10090.0,170722,10089.5,124646,10089.0,224036,10088.5,126678,10088.0,154786,10087.5,193216"
  private val midPoint     = 10099.75
  private val vwapAsks     = 8326.116806682758
  private val vwapBids     = 10016.558394559637
  private val vwapMidpoint = 9171.337600621198

  private val window = List(
    "2020-02-09 19:34:20,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45732,227.35000610351562,115971,227.3000030517578,31426,227.25,41849,227.1999969482422,123438,227.14999389648438,275990,227.10000610351562,104768,227.0500030517578,65087,227.0,151885,226.9499969482422,45107,226.89999389648438,66288,226.85000610351562,65475,226.8000030517578,262644,226.75,43805,226.6999969482422,190466,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:20,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45732,227.35000610351562,108794,227.3000030517578,31426,227.25,41849,227.1999969482422,123438,227.14999389648438,275990,227.10000610351562,104768,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,43805,226.6999969482422,190466,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:20,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45732,227.35000610351562,108794,227.3000030517578,31426,227.25,41849,227.1999969482422,118438,227.14999389648438,280990,227.10000610351562,120112,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,43805,226.6999969482422,190466,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:20,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45732,227.35000610351562,108762,227.3000030517578,31456,227.25,41849,227.1999969482422,118414,227.14999389648438,281012,227.10000610351562,120112,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,43805,226.6999969482422,190466,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31843,226.1999969482422,57140,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:20,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45733,227.35000610351562,108795,227.3000030517578,31426,227.25,41849,227.1999969482422,118414,227.14999389648438,281012,227.10000610351562,120112,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,43805,226.6999969482422,190466,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:20,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45733,227.35000610351562,108795,227.3000030517578,31974,227.25,41849,227.1999969482422,125591,227.14999389648438,281012,227.10000610351562,120112,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,66408,226.6999969482422,167863,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:21,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45733,227.35000610351562,108795,227.3000030517578,31974,227.25,41849,227.1999969482422,125614,227.14999389648438,280990,227.10000610351562,120112,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,66408,226.6999969482422,167863,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:21,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45733,227.35000610351562,108795,227.3000030517578,31974,227.25,41849,227.1999969482422,125591,227.14999389648438,281011,227.10000610351562,120112,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,66408,226.6999969482422,167863,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:22,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45733,227.35000610351562,108795,227.3000030517578,31426,227.25,41849,227.1999969482422,125591,227.14999389648438,281011,227.10000610351562,120112,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,66408,226.6999969482422,167863,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012",
    "2020-02-09 19:34:22,ETHUSD,228.35000610351562,61764,228.3000030517578,33703,228.25,362781,228.1999969482422,21916,228.14999389648438,31973,228.10000610351562,11104,228.0500030517578,57410,228.0,57606,227.9499969482422,45182,227.89999389648438,2617,227.85000610351562,32620,227.8000030517578,18271,227.75,144,227.6999969482422,68573,227.64999389648438,58833,227.60000610351562,25338,227.5500030517578,113586,227.5,59850,227.4499969482422,32797,227.39999389648438,45733,227.35000610351562,108795,227.3000030517578,31426,227.25,41849,227.1999969482422,126681,227.14999389648438,281011,227.10000610351562,120112,227.0500030517578,65087,227.0,120580,226.9499969482422,45107,226.89999389648438,97593,226.85000610351562,65475,226.8000030517578,262644,226.75,66408,226.6999969482422,168955,226.64999389648438,98699,226.60000610351562,88598,226.5500030517578,80560,226.5,78624,226.4499969482422,46118,226.39999389648438,102283,226.35000610351562,55881,226.3000030517578,26206,226.25,31874,226.1999969482422,57107,226.14999389648438,38701,226.10000610351562,47032,226.0500030517578,35978,226.0,69727,225.9499969482422,46699,225.89999389648438,37012"
  )
  private val correctSma = 216.2591129560777
  private val correctEma = 216.13948375102194
}
